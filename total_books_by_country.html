<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Total books by country</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 20px; color: #222; }
    .header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px; gap: 12px; }
    .nav { display:flex; gap:8px; align-items:center; }
    .btn { display: inline-block; padding: 8px 12px; background: #0b5ed7; color: #fff; text-decoration: none; border-radius: 6px; }
    .btn:hover { filter: brightness(0.95); }
    .layout { display: grid; grid-template-columns: 1.4fr 1fr; gap: 20px; }
    #map { position: relative; width: 100%; height: 540px; border: 1px solid #e3e3e3; border-radius: 8px; background: #fafafa; }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 8px 10px; border-bottom: 1px solid #eee; }
    th { text-align: left; cursor: pointer; user-select: none; }
    .muted { color: #666; font-size: 0.9em; }
    .error { color: #b00020; margin-top: 8px; }
    .pill { display: inline-block; padding: 2px 8px; border-radius: 9999px; background: #f1f3f5; font-size: 12px; color: #495057; }
    .legend { display: flex; gap: 8px; align-items: center; margin: 10px 0 16px; }
    .swatch { width: 18px; height: 12px; border-radius: 2px; border: 1px solid rgba(0,0,0,.08); }
    @media (max-width: 1000px) { .layout { grid-template-columns: 1fr; } }
  </style>
  <!-- DataMaps dependencies (allowed by current CSP) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.17/d3.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/topojson/1.6.19/topojson.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/datamaps/0.5.9/datamaps.world.min.js"></script>
</head>
<body>
  <div class="header">
    <h1>Total books by country</h1>
    <nav class="nav">
      <a class="btn" href="/">Home</a>
      <a class="btn" href="/total-books-by-country">Total books</a>
      <a class="btn" href="/servers-by-country">Online servers</a>
      <a class="btn" href="/demeter">Demeter</a>
    </nav>
  </div>

  <div class="muted">Data source: /api/book_counts_total and /api/book_counts_iso_total</div>

  <div class="layout">
    <div>
      <div id="map"></div>
      <div class="legend" id="legend"></div>
      <div id="mapError" class="error" style="display:none"></div>
      <div class="muted" id="unmapped" style="margin-top:8px;"></div>
    </div>
    <div>
      <h3 style="margin:0 0 10px;">Country table</h3>
      <table id="tbl">
        <thead>
          <tr>
            <th data-key="country">Country</th>
            <th data-key="count">Books</th>
            <th>ISO3</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <div id="tableError" class="error" style="display:none"></div>
    </div>
  </div>

  <script>
    (function(){
      var map;

      function quantizeColor(value, breaks) {
        var colors = ['#edf8e9','#c7e9c0','#a1d99b','#74c476','#41ab5d','#238b45','#006d2c','#00441b'];
        var idx = 0;
        for (var i = 0; i < breaks.length; i++) {
          if (value > breaks[i]) idx = i + 1;
        }
        return colors[Math.min(idx, colors.length - 1)];
      }

      function buildLegend(breaks) {
        var legend = document.getElementById('legend');
        legend.innerHTML = '';
        var title = document.createElement('span');
        title.textContent = 'Books';
        title.style.marginRight = '8px';
        legend.appendChild(title);
        var parts = [0].concat(breaks);
        for (var i = 0; i < parts.length; i++) {
          var min = parts[i];
          var max = parts[i+1];
          var val = max || min;
          var color = quantizeColor(val, breaks);
          var box = document.createElement('span');
          box.className = 'swatch';
          box.style.background = color;
          box.title = max ? (min + 1) + '–' + max : (min + '+');
          legend.appendChild(box);
        }
      }

      function renderMap(counts) {
        var values = Object.keys(counts).map(function(k){ return counts[k]; });
        values.sort(function(a,b){ return a-b; });
        var breaks = [];
        if (values.length) {
          for (var q=1; q<=7; q++) {
            var idx = Math.floor(values.length * q / 8);
            breaks.push(values[Math.min(idx, values.length-1)]);
          }
        }
        buildLegend(breaks);

        if (!map) {
          map = new Datamap({
            element: document.getElementById('map'),
            projection: 'mercator',
            fills: { defaultFill: '#f0f0f0' },
            geographyConfig: {
              highlightFillColor: function(geo) {
                var iso = geo.id;
                var v = counts[iso] || 0;
                return quantizeColor(v, breaks);
              },
              highlightBorderColor: '#666',
              borderColor: '#ddd',
              popupTemplate: function(geo, data) {
                var iso = geo.id;
                var v = counts[iso] || 0;
                return '<div class="hoverinfo"><strong>' + geo.properties.name +
                       '</strong><br/>Books: ' + v + '</div>';
              }
            },
            data: {}
          });
        }

        var colors = {};
        Object.keys(counts).forEach(function(iso){
          colors[iso] = quantizeColor(counts[iso], breaks);
        });
        map.updateChoropleth(colors);
      }

      function renderTable(entries) {
        var tbody = document.querySelector('#tbl tbody');
        tbody.innerHTML = '';
        entries.forEach(function(r) {
          var tr = document.createElement('tr');
          var tdC = document.createElement('td');
          tdC.textContent = r.country || '(Unknown)';
          var tdN = document.createElement('td');
          tdN.textContent = r.count;
          var tdI = document.createElement('td');
          tdI.innerHTML = r.iso ? ('<span class="pill">'+r.iso+'</span>') : '';
          tr.appendChild(tdC); tr.appendChild(tdN); tr.appendChild(tdI);
          tbody.appendChild(tr);
        });

        var ths = document.querySelectorAll('#tbl th[data-key]');
        [].forEach.call(ths, function(th){
          th.onclick = function() {
            var key = th.getAttribute('data-key');
            var asc = th._asc = !th._asc;
            entries.sort(function(a,b){
              if (a[key] === b[key]) return 0;
              return (a[key] > b[key] ? 1 : -1) * (asc ? 1 : -1);
            });
            renderTable(entries);
          };
        });
      }

      function load() {
        fetch('/api/book_counts_iso_total', { credentials: 'same-origin' })
          .then(function(r){ return r.json(); })
          .then(function(payload){
            if (payload.error) {
              document.getElementById('mapError').style.display = 'block';
              document.getElementById('mapError').textContent = payload.error;
              document.getElementById('tableError').style.display = 'block';
              document.getElementById('tableError').textContent = payload.error;
              return;
            }
            var counts = payload.counts || {};
            var unmapped = payload.unmapped || {};

            var entries = [];
            Object.keys(counts).forEach(function(iso){
              entries.push({ country: iso, iso: iso, count: counts[iso] });
            });
            Object.keys(unmapped).forEach(function(name){
              entries.push({ country: name, iso: '', count: unmapped[name] });
            });
            entries.sort(function(a,b){ return b.count - a.count; });

            renderMap(counts);
            renderTable(entries);

            var un = Object.keys(unmapped);
            if (un.length) {
              document.getElementById('unmapped').innerHTML =
                'Unmapped country names: ' + un.slice(0, 8).join(', ') + (un.length > 8 ? '…' : '');
            }
          })
          .catch(function(err){
            document.getElementById('mapError').style.display = 'block';
            document.getElementById('mapError').textContent = 'Failed to load data: ' + err;
            document.getElementById('tableError').style.display = 'block';
            document.getElementById('tableError').textContent = 'Failed to load data: ' + err;
          });
      }

      load();
    })();
  </script>
</body>
</html>
