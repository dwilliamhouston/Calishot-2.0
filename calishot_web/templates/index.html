<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calishot - World Map</title>
    <!-- Load required libraries with specific versions known to work together -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/5.16.0/d3.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/topojson/3.0.2/topojson.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/datamaps/0.5.9/datamaps.world.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
        }
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
            background-color: #f5f5f5;
        }
        #container {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        #map-container {
            position: relative;
            width: 100%;
            height: 600px;
            min-height: 400px;
            border: 1px solid #ddd;
            border-radius: 5px;
            overflow: hidden;
            background-color: #f9f9f9;
        }
        #map-container svg {
            width: 100%;
            height: 100%;
        }
        h1 {
            text-align: center;
            color: #333;
        }
        .legend {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: white;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 12px;
        }
        .legend-item {
            margin: 5px 0;
        }
        .legend-color {
            display: inline-block;
            width: 15px;
            height: 15px;
            margin-right: 5px;
            vertical-align: middle;
        }
        #country-info {
            margin-top: 20px;
            padding: 10px;
            background: #f5f5f5;
            border-radius: 5px;
            min-height: 50px;
        }
    </style>
</head>
<body>
    <div id="container">
        <h1>Calishot - Calibre Servers by Country</h1>
        <nav style="display:flex; gap:8px; justify-content:center; margin: 10px 0 20px;">
            <a href="/" style="text-decoration:none; padding:8px 12px; border:1px solid #ccc; border-radius:6px; background:#fff; color:#333;">Home</a>
            <a href="/total-books-by-country" style="text-decoration:none; padding:8px 12px; border:1px solid #ccc; border-radius:6px; background:#fff; color:#333;">Total books</a>
            <a href="/servers-by-country" style="text-decoration:none; padding:8px 12px; border:1px solid #ccc; border-radius:6px; background:#fff; color:#333;">Online servers</a>
            <a href="/demeter" style="text-decoration:none; padding:8px 12px; border:1px solid #ccc; border-radius:6px; background:#fff; color:#333;">Demeter</a>
            <a href="http://85.10.194.198:5001/index/summary" style="text-decoration:none; padding:8px 12px; border:1px solid #ccc; border-radius:6px; background:#fff; color:#333;">Books List</a>
            <a href="http://85.10.194.198:5002/sites/sites" style="text-decoration:none; padding:8px 12px; border:1px solid #ccc; border-radius:6px; background:#fff; color:#333;">Server List</a>
        </nav>
        <div id="map-container"></div>
        <div id="country-info">
            <p>Click on a country to see details</p>
        </div>
    </div>

    <script>
        // Wait for the DOM to be fully loaded
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM fully loaded');
            
            // Check if DataMaps is loaded
            if (typeof Datamap === 'undefined') {
                console.error('DataMaps not loaded. Please check your internet connection.');
                document.getElementById('map-container').innerHTML = 
                    '<div style="padding: 20px; color: red;">' +
                    'Error: Could not load required map libraries. Please check your internet connection and refresh the page.' +
                    '</div>';
                return;
            }
            
            console.log('Initializing map...');
            
            try {
                // Initialize the map
                console.log('Initializing map with DataMaps');
                
                // Simple map initialization with minimal configuration
                try {
                    const map = new Datamap({
                        element: document.getElementById('map-container'),
                        scope: 'world',
                        responsive: true,
                        fills: {
                            defaultFill: '#F5F5F5',
                            high: '#1a9850',
                            medium: '#91cf60',
                            low: '#d9ef8b',
                            verylow: '#ffffbf',
                            minimum: '#fef0d9',
                            unknown: '#f1f1f1'
                        },
                        data: {},
                        geographyConfig: {
                            highlightFillColor: '#3e8e41',
                            highlightBorderColor: '#000000',
                            highlightBorderWidth: 1,
                            popupOnHover: true,
                            highlightOnHover: true,
                            borderColor: '#888',
                            borderWidth: 0.5,
                            popupTemplate: function(geo, data) {
                                if (!data) return '<div class="hoverinfo">' + geo.properties.name + ': No data';
                                return [
                                    '<div class="hoverinfo">',
                                    '<strong>', geo.properties.name, '</strong><br>',
                                    'Servers: <strong>', data.count, '</strong>',
                                    '</div>'
                                ].join('');
                            }
                        },
                        done: function(datamap) {
                            console.log('Map initialized, loading data...');
                            
                            // Show loading message
                            const loadingMsg = document.createElement('div');
                            loadingMsg.style.position = 'absolute';
                            loadingMsg.style.top = '50%';
                            loadingMsg.style.left = '50%';
                            loadingMsg.style.transform = 'translate(-50%, -50%)';
                            loadingMsg.textContent = 'Loading data...';
                            document.getElementById('map-container').appendChild(loadingMsg);
                            
                            // Load data from our API
                            fetch('/api/country_counts')
                                .then(response => {
                                    if (!response.ok) {
                                        throw new Error(`HTTP error! status: ${response.status}`);
                                    }
                                    return response.json();
                                })
                                .then(countryCounts => {
                                    console.log('Received country data:', countryCounts);
                                    
                                    // Remove loading message
                                    if (loadingMsg.parentNode) {
                                        loadingMsg.parentNode.removeChild(loadingMsg);
                                    }
                                    
                                    if (Object.keys(countryCounts).length === 0) {
                                        throw new Error('No country data available');
                                    }
                                    
                                    // Process the data for the map
                                    const maxCount = Math.max(...Object.values(countryCounts));
                                    const data = {};
                                    
                                    for (const [country, count] of Object.entries(countryCounts)) {
                                        data[country] = {
                                            fillKey: getFillKey(count, maxCount),
                                            count: count
                                        };
                                    }
                                    
                                    // Update the map with the new data
                                    datamap.updateChoropleth(data);
                                    
                                    // Add click handler for countries
                                    datamap.svg.selectAll('.datamaps-subunit').on('click', function(geography) {
                                        const countryName = geography.properties.name;
                                        const count = countryCounts[geography.id] || 0;
                                        document.getElementById('country-info').innerHTML = `
                                            <h3>${countryName}</h3>
                                            <p>Number of servers: <strong>${count}</strong></p>
                                        `;
                                    });
                                    
                                    // Add legend
                                    const legend = document.createElement('div');
                                    legend.id = 'legend';
                                    legend.innerHTML = `
                                        <div class="legend-item"><span class="legend-color" style="background-color: #1a9850"></span> High (${Math.ceil(maxCount * 0.7)}-${maxCount})</div>
                                        <div class="legend-item"><span class="legend-color" style="background-color: #91cf60"></span> Medium (${Math.ceil(maxCount * 0.4)}-${Math.ceil(maxCount * 0.7)})</div>
                                        <div class="legend-item"><span class="legend-color" style="background-color: #d9ef8b"></span> Low (${Math.ceil(maxCount * 0.1)}-${Math.ceil(maxCount * 0.4)})</div>
                                        <div class="legend-item"><span class="legend-color" style="background-color: #ffffbf"></span> Very Low (1-${Math.ceil(maxCount * 0.1)})</div>
                                        <div class="legend-item"><span class="legend-color" style="background-color: #fef0d9"></span> Minimum (0-1)</div>
                                    `;
                                    document.getElementById('map-container').appendChild(legend);
                                    
                                })
                                .catch(error => {
                                    console.error('Error loading country data:', error);
                                    
                                    // Remove loading message if still present
                                    if (loadingMsg.parentNode) {
                                        loadingMsg.parentNode.removeChild(loadingMsg);
                                    }
                                    
                                    const errorDiv = document.createElement('div');
                                    errorDiv.style.color = 'red';
                                    errorDiv.style.padding = '20px';
                                    errorDiv.style.textAlign = 'center';
                                    errorDiv.innerHTML = `
                                        <h3>Error Loading Data</h3>
                                        <p>${error.message || 'Unknown error occurred'}</p>
                                        <p>Check the browser console for more details.</p>
                                        <button onclick="window.location.reload()" style="padding: 8px 16px; margin-top: 10px;">
                                            Reload Page
                                        </button>
                                    `;
                                    
                                    document.getElementById('map-container').appendChild(errorDiv);
                                    
                                    // Also update the info box
                                    document.getElementById('country-info').innerHTML = `
                                        <div style="color: red; padding: 10px; background: #ffebee; border-radius: 4px;">
                                            <strong>Error:</strong> ${error.message || 'Failed to load country data'}
                                        </div>
                                    `;
                                });
                        }
                    });
                    
                    // Store the map instance for later use
                    window.map = map;
                    
                    // Handle window resize with debounce
                    let resizeTimer;
                    window.addEventListener('resize', function() {
                        clearTimeout(resizeTimer);
                        resizeTimer = setTimeout(function() {
                            console.log('Window resized, updating map...');
                            try {
                                map.resize();
                            } catch (e) {
                                console.error('Error during resize:', e);
                            }
                        }, 250);
                    });
                    
                } catch (e) {
                    console.error('Error initializing map:', e);
                    document.getElementById('map-container').innerHTML = 
                        '<div style="padding: 20px; color: red;">' +
                        'Error initializing map: ' + (e.message || 'Unknown error') +
                        '<br><br><button onclick="window.location.reload()">Reload Page</button>' +
                        '</div>';
                }
            // Helper function to determine fill color based on count
            function getFillKey(count, max) {
                if (count === 0) return 'unknown';
                if (count === 1) return 'minimum';
                const ratio = count / max;
                if (ratio > 0.7) return 'high';
                if (ratio > 0.4) return 'medium';
                if (ratio > 0.1) return 'low';
                return 'verylow';
            }

            // Initialize the map
            console.log('Initializing map with DataMaps');
            
            try {
                const map = new Datamap({
                    element: document.getElementById('map-container'),
                    scope: 'world',
                    responsive: true,
                    fills: {
                        defaultFill: '#F5F5F5',
                        high: '#1a9850',
                        medium: '#91cf60',
                        low: '#d9ef8b',
                        verylow: '#ffffbf',
                        minimum: '#fef0d9',
                        unknown: '#f1f1f1'
                    },
                    data: {},
                    geographyConfig: {
                        highlightFillColor: '#3e8e41',
                        highlightBorderColor: '#000000',
                        highlightBorderWidth: 1,
                        popupOnHover: true,
                        highlightOnHover: true,
                        borderColor: '#888',
                        borderWidth: 0.5,
                        popupTemplate: function(geo, data) {
                            if (!data) return '<div class="hoverinfo">' + geo.properties.name + ': No data';
                            return [
                                '<div class="hoverinfo">',
                                '<strong>', geo.properties.name, '</strong><br>',
                                'Servers: <strong>', data.count, '</strong>',
                                '</div>'
                            ].join('');
                        }
                    },
                    done: function(datamap) {
                        console.log('Map initialized, loading data...');
                        
                        // Show loading message
                        const loadingMsg = document.createElement('div');
                        loadingMsg.style.position = 'absolute';
                        loadingMsg.style.top = '50%';
                        loadingMsg.style.left = '50%';
                        loadingMsg.style.transform = 'translate(-50%, -50%)';
                        loadingMsg.textContent = 'Loading data...';
                        document.getElementById('map-container').appendChild(loadingMsg);
                        
                        // Load data from our API
                        fetch('/api/country_counts')
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(countryCounts => {
                        console.log('Received country data:', countryCounts);
                        
                        // Remove loading message
                        if (loadingMsg.parentNode) {
                            loadingMsg.parentNode.removeChild(loadingMsg);
                        }
                        
                        if (Object.keys(countryCounts).length === 0) {
                            throw new Error('No country data available');
                        }
                        // Process the data for the map
                        const maxCount = Math.max(...Object.values(countryCounts));
                        
                        const dataset = {};
                        
                        // Create a map of country names to ISO codes
                        const countryToISO = {};
                        Object.keys(datamap.worldTopo.objects.world.geometries).forEach(function(d) {
                            const country = datamap.worldTopo.objects.world.geometries[d];
                            countryToISO[country.properties.name] = country.id;
                        });
                        
                        // Map our country codes to the DataMaps format
                        Object.entries(countryCounts).forEach(([countryCode, count]) => {
                            // Find the country in the map data
                            const country = Object.entries(datamap.worldTopo.objects.world.geometries).find(
                                ([key, geo]) => geo.id === countryCode
                            );
                            
                            if (country) {
                                const fillKey = getFillKey(count, maxCount);
                                dataset[country[0]] = {
                                    fillKey: fillKey,
                                    count: count
                                };
                            }
                        });
                        
                        // Update the map with the data
                        datamap.updateChoropleth(dataset);
                        
                        // Add click handler
                        datamap.svg.selectAll('.datamaps-subunit').on('click', function(geography) {
                            const countryCode = geography.id;
                            const countryName = geography.properties.name;
                            const count = countryCounts[countryCode] || 0;
                            
                            document.getElementById('country-info').innerHTML = `
                                <h3>${countryName}</h3>
                                <p>Servers: <strong>${count}</strong></p>
                                <p>Country Code: <strong>${countryCode}</strong></p>
                            `;
                        });
                    })
                    .catch(error => {
                        console.error('Error loading country data:', error);
                        
                        // Remove loading message if still present
                        if (loadingMsg.parentNode) {
                            loadingMsg.parentNode.removeChild(loadingMsg);
                        }
                        
                        const errorDiv = document.createElement('div');
                        errorDiv.style.color = 'red';
                        errorDiv.style.padding = '20px';
                        errorDiv.style.textAlign = 'center';
                        errorDiv.innerHTML = `
                            <h3>Error Loading Data</h3>
                            <p>${error.message || 'Unknown error occurred'}</p>
                            <p>Check the browser console for more details.</p>
                            <button onclick="window.location.reload()" style="padding: 8px 16px; margin-top: 10px;">
                                Reload Page
                            </button>
                        `;
                        
                        document.getElementById('map-container').appendChild(errorDiv);
                        
                        // Also update the info box
                        document.getElementById('country-info').innerHTML = `
                            <div style="color: red; padding: 10px; background: #ffebee; border-radius: 4px;">
                                <strong>Error:</strong> ${error.message || 'Failed to load country data'}
                            </div>
                        `;
                    });
                
                // Helper function to determine fill color based on count
                function getFillKey(count, max) {
                    if (count === 0) return 'unknown';
                    const ratio = count / max;
                    if (ratio > 0.8) return 'high';
                    if (ratio > 0.5) return 'medium';
                    if (ratio > 0.2) return 'low';
                    if (ratio > 0.05) return 'verylow';
                    return 'minimum';
                }
            }
        });
        
                // Handle window resize with debounce
                let resizeTimer;
                window.addEventListener('resize', function() {
                    clearTimeout(resizeTimer);
                    resizeTimer = setTimeout(function() {
                        console.log('Window resized, updating map...');
                        try {
                            const container = document.getElementById('map-container');
                            if (container) {
                                container.innerHTML = '';
                                map.resize();
                            }
                        } catch (e) {
                            console.error('Error during resize:', e);
                        }
                    }, 250);
                });
                
                console.log('Map setup complete');
                
            } catch (e) {
                console.error('Error initializing map:', e);
                document.getElementById('map-container').innerHTML = 
                    '<div style="padding: 20px; color: red;">' +
                    'Error initializing map: ' + (e.message || 'Unknown error') +
                    '<br><br><button onclick="window.location.reload()">Reload Page</button>' +
                    '</div>';
            }
        });
        
        // Add a debug function to check map status
        window.checkMapStatus = function() {
            console.log('Map status check:');
            console.log('- Map container:', document.getElementById('map-container'));
            console.log('- DataMaps loaded:', typeof Datamap !== 'undefined');
            console.log('- D3 loaded:', typeof d3 !== 'undefined');
            console.log('- TopoJSON loaded:', typeof topojson !== 'undefined');
        };
        
        // Run initial status check
        setTimeout(window.checkMapStatus, 1000);
    </script>
</body>
</html>
