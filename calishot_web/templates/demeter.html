<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PythonDemeter</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 0; padding: 0; background:#0b1220; color:#e6edf3; }
    header { padding: 16px 24px; border-bottom: 1px solid #243b55; display:flex; align-items:center; justify-content:space-between; }
    a { color: #8ab4f8; }
    .container { padding: 16px 24px; display:grid; grid-template-columns: 360px 1fr; gap: 16px; }
    @media (max-width: 980px){ .container { grid-template-columns: 1fr; } }
    .card { background:#0f1a2b; border:1px solid #243b55; border-radius: 10px; padding: 16px; }
    .card h3 { margin: 0 0 12px; font-size: 16px; }
    .row { display:flex; gap:10px; margin-bottom:10px; flex-wrap: wrap; }
    input, select, button, textarea { background:#0b1220; color:#e6edf3; border:1px solid #2a4061; border-radius:8px; padding:10px 12px; }
    input, select, button { height: 40px; }
    textarea { width:100%; min-height: 160px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size:12px; }
    .log { white-space: pre-wrap; background:#071020; border:1px dashed #27446e; padding:12px; border-radius:8px; height: 360px; overflow:auto; }
    .pill { display:inline-block; padding:4px 10px; border-radius:999px; border:1px solid #385a8f; background:#112038; font-size:12px; }
    .muted { color:#a7b3c5; }
    .grid-2 { display:grid; grid-template-columns: 1fr 1fr; gap: 10px; }

    /* Buttons */
    .btn { cursor:pointer; user-select:none; border-radius:8px; border:1px solid transparent; padding:10px 14px; font-weight:600; letter-spacing: .2px; }
    .btn:focus { outline: 2px solid #4c87ff55; outline-offset: 2px; }
    .btn-primary { background:#2563eb; border-color:#3770ee; color:#fff; }
    .btn-primary:hover { background:#1f55c7; }
    .btn-secondary { background:#1f2f4a; border-color:#3a5b8f; color:#e6edf3; }
    .btn-secondary:hover { background:#254062; }
    .btn-outline { background:transparent; border-color:#3a5b8f; color:#cfe1ff; }
    .btn-outline:hover { background:#13233c; }
    .btn-danger { background:#8b1e2c; border-color:#c43b4d; color:#fff; }
    .btn-danger:hover { background:#a32638; }
    .btn-block { width:100%; }
  </style>
</head>
<body>
  <header>
    <div>
      <strong>PythonDemeter</strong>
      <span class="pill" id="jobStatus">Idle</span>
    </div>
    <nav class="muted" style="display:flex; gap:10px; align-items:center;">
      <a href="/">Home</a>
      <a href="/total-books-by-country">Total books</a>
      <a href="/servers-by-country">Online servers</a>
      <a href="/demeter">Demeter</a>
    </nav>
  </header>

  <div class="container">
    <div class="left">
      <div class="card">
        <h3>Hosts</h3>
        <div class="row">
          <button class="btn btn-primary" onclick="doHostList()">List (active)</button>
          <button class="btn btn-secondary" onclick="doHostListAll()">List (all)</button>
        </div>
        <div class="row">
          <input id="hostAdd" placeholder="https://example.com" style="flex:1" />
          <button class="btn btn-primary" onclick="doHostAdd()">Add</button>
        </div>
        <div class="row">
          <input id="hostId" placeholder="demeter_id" style="width:140px" />
          <button class="btn btn-secondary" onclick="doHostEnable()">Enable ID</button>
          <button class="btn btn-outline" onclick="doHostDisable()">Disable ID</button>
          <button class="btn btn-danger" onclick="doHostRemove()" title="Remove host by demeter_id">Remove</button>
        </div>
        <div class="row">
          <input id="countryCode" placeholder="Country code (e.g., us)" style="flex:1" />
          <button class="btn btn-secondary" onclick="doEnableCountry()" title="Enable all hosts in country">Enable Country</button>
          <button class="btn btn-primary" onclick="doEnableAll()" title="Enable all online hosts">Enable All</button>
          <button class="btn btn-outline" onclick="doDisableAll()" title="Disable all active hosts">Disable All</button>
        </div>
      </div>

      <div class="card">
        <h3>Scrape</h3>
        <div class="grid-2">
          <div class="row">
            <select id="ext" style="flex:1">
              <option value="epub" selected>epub</option>
              <option value="pdf">pdf</option>
              <option value="azw3">azw3</option>
              <option value="mobi">mobi</option>
              <option value="azw">azw</option>
              <option value="prc">prc</option>
              <option value="azw1">azw1</option>
              <option value="tpz">tpz</option>
              <option value="txt">txt</option>
              <option value="rtf">rtf</option>
              <option value="html">html</option>
            </select>
          </div>
          <div class="row"><input id="outdir" value="books" placeholder="output dir" style="flex:1" /></div>
          <div class="row"><input id="authors" placeholder="authors LIKE (e.g., %King%)" style="flex:1" /></div>
          <div class="row"><input id="titles" placeholder="title LIKE (e.g., %Dune%)" style="flex:1" /></div>
        </div>
        <div class="row" style="margin-top:8px">
          <button class="btn btn-primary" onclick="runScrape()">Run Scrape</button>
          <button class="btn btn-outline" onclick="clearLog()">Clear Log</button>
          <button class="btn btn-secondary" onclick="resetCancel()" title="Clear cancellation flag so new scrapes can start">Reset Cancellation</button>
          <button class="btn btn-danger" onclick="cancelAll()" title="Request cancellation of all running scrapes">Cancel All Scrapes</button>
        </div>
      </div>

      <div class="card">
        <h3>Host Stats</h3>
        <div class="row">
          <input id="statsId" placeholder="demeter_id" style="width:120px" />
          <button class="btn btn-secondary" onclick="doHostStats()">Get Stats</button>
        </div>
      </div>
    </div>

    <div class="right">
      <div class="card">
        <h3>Output</h3>
        <div class="log" id="output"></div>
      </div>
    </div>
  </div>

  <script>
    const out = document.getElementById('output');
    const jobPill = document.getElementById('jobStatus');
    let lastLog = '';

    function append(text){ out.textContent += text + "\n"; out.scrollTop = out.scrollHeight; }
    function set(text){ out.textContent = text + "\n"; }
    function clearLog(){ out.textContent = ''; }

    async function post(url, body) {
      const res = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body || {}) });
      let data = null;
      try { data = await res.json(); } catch (e) { /* non-JSON error */ }
      if (!res.ok) {
        const msg = data && (data.error || data.stderr || data.output || data.traceback || JSON.stringify(data));
        throw new Error(`HTTP ${res.status}${msg ? ' - ' + msg : ''}`);
      }
      return data;
    }

    async function doHostList(){ try { const j = await post('/api/demeter/host/list'); append((j.output||'').trim()); } catch(e){ append('Error: ' + e.message); } }
    async function doHostListAll(){ try { const j = await post('/api/demeter/host/list_all'); append((j.output||'').trim()); } catch(e){ append('Error: ' + e.message); } }
    async function doHostAdd(){
      const val = document.getElementById('hostAdd').value.trim(); if(!val) return;
      try { const j = await post('/api/demeter/host/add', { hosturl: val }); append((j.output||'').trim()); } catch(e){ append('Error: ' + e.message); }
    }
    async function doHostRemove(){
      const val = document.getElementById('hostId').value.trim(); if(!val) return;
      try { const j = await post('/api/demeter/host/rm', { hostid: val }); append((j.output||'').trim()); } catch(e){ append('Error: ' + e.message); }
    }
    async function doHostEnable(){
      const val = document.getElementById('hostId').value.trim(); if(!val) return;
      try { const j = await post('/api/demeter/host/enable', { hostid: val }); append((j.output||'').trim()); } catch(e){ append('Error: ' + e.message); }
    }
    async function doHostDisable(){
      const val = document.getElementById('hostId').value.trim(); if(!val) return;
      try { const j = await post('/api/demeter/host/disable', { hostid: val }); append((j.output||'').trim()); } catch(e){ append('Error: ' + e.message); }
    }
    async function doEnableCountry(){
      const cc = document.getElementById('countryCode').value.trim(); if(!cc) return;
      try { const j = await post('/api/demeter/host/enable', { enable_country: cc }); append((j.output||'').trim()); } catch(e){ append('Error: ' + e.message); }
    }
    async function doEnableAll(){
      const ok = confirm('Are you sure you want to enable ALL online hosts? This will activate every host.');
      if(!ok){ append('Enable All cancelled.'); return; }
      try { const j = await post('/api/demeter/host/enable', { enable_all: true }); append((j.output||'').trim()); } catch(e){ append('Error: ' + e.message); }
    }
    async function doDisableAll(){ const j = await post('/api/demeter/host/disable', { disable_all: true }); append(j.output.trim()); }

    async function runScrape(){
      const payload = {
        extension: document.getElementById('ext').value.trim() || 'epub',
        outputdir: document.getElementById('outdir').value.trim() || 'books',
        authors: document.getElementById('authors').value.trim() || null,
        titles: document.getElementById('titles').value.trim() || null,
      };
      try {
        const res = await post('/api/demeter/scrape/run', payload);
        if (res && res.status === 'cancelled'){
          append('Cancellation requested. Not starting new scrape. Click "Reset Cancellation" to allow new scrapes.');
          jobPill.textContent = 'Cancelled'; jobPill.style.background = '#6b1b24';
          return;
        }
        lastLog = '';
        jobPill.textContent = 'Running'; jobPill.style.background = '#7a4e10';
        pollStatus(res.job_id);
      } catch(e){
        append('Failed to start scrape.');
        console.error(e);
      }
    }

    async function cancelAll(){
      try {
        const res = await post('/api/demeter/scrape/cancel_all');
        append(`Cancelled jobs: ${res.cancelled_jobs || 0}`);
        jobPill.textContent = 'Cancelled'; jobPill.style.background = '#6b1b24';
      } catch(e){ append('Cancel request failed'); console.error(e); }
    }

    async function resetCancel(){
      try {
        const res = await post('/api/demeter/scrape/reset_cancel');
        append(res.message || 'Cancellation flag cleared.');
        jobPill.textContent = 'Idle'; jobPill.style.background = '';
      } catch(e){ append('Reset cancellation failed'); console.error(e); }
    }

    async function pollStatus(jobId){
      const timer = setInterval(async () => {
        try {
          const url = '/api/demeter/scrape/status?job_id=' + encodeURIComponent(jobId);
          const res = await fetch(url);
          if(!res.ok) throw new Error('status ' + res.status);
          const j = await res.json();
          if(j.log) {
            const newPart = j.log.substring(lastLog.length);
            if(newPart) { append(newPart); }
            lastLog = j.log;
          }
          if(j.status === 'completed'){
            clearInterval(timer);
            jobPill.textContent = 'Completed'; jobPill.style.background = '#165a1c';
          } else {
            jobPill.textContent = 'Running'; jobPill.style.background = '#7a4e10';
          }
        } catch(e){ console.error(e); }
      }, 1500);
    }

    async function doHostStats(){
      const val = document.getElementById('statsId').value.trim(); if(!val) return;
      try { const j = await post('/api/demeter/host/stats', { hostid: val }); append((j.output||'').trim()); } catch(e){ append('Error: ' + e.message); }
    }
  </script>
</body>
</html>
